# AWS KMS Direct Support for Signing - Implementation Artifact

## KMS Sign API Request Structure

### Request Format
The KMS signing plugin constructs and sends the following request to AWS KMS:

```
POST / HTTP/1.1
Host: kms.{region}.amazonaws.com
Content-Type: application/x-amz-json-1.1
X-Amz-Target: TrentService.Sign
Authorization: AWS4-HMAC-SHA256 ...

{
  "KeyId": "arn:aws:kms:{region}:{account-id}:key/{key-id}",
  "Message": <binary-audit-trail-hash>,
  "SigningAlgorithm": "Ed25519",
  "MessageFormat": "RAW"
}
```

### Request Parameters
- **KeyId**: ARN or key ID of the asymmetric KMS key (must support Ed25519)
- **Message**: Raw hash bytes of the audit trail (SHA-256 digest)
- **SigningAlgorithm**: Fixed to "Ed25519" for EdDSA signing
- **MessageFormat**: "RAW" indicates unpadded binary message format

### Response Structure
```json
{
  "Signature": <binary-signature-bytes>,
  "KeyId": "arn:aws:kms:{region}:{account-id}:key/{key-id}",
  "SigningAlgorithm": "Ed25519"
}
```

## IAM Permissions Required

The principal (user, role, or service account) executing the KMS Sign operation must have the following IAM policy:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowKMSEdDSASigning",
      "Effect": "Allow",
      "Action": [
        "kms:Sign"
      ],
      "Resource": "arn:aws:kms:*:ACCOUNT-ID:key/KEY-ID",
      "Condition": {
        "StringEquals": {
          "kms:SigningAlgorithm": "Ed25519"
        }
      }
    }
  ]
}
```

### Policy Notes
1. **Action**: Only `kms:Sign` is required (not `kms:DescribeKey` or other operations)
2. **Resource**: Restrict to specific KMS key ARN to follow least-privilege principle
3. **Condition**: Optionally restrict to Ed25519 algorithm
4. **Key Requirements**: The KMS key must be asymmetric with Ed25519 support

## Key Generation

The KMS key must be created with Ed25519 support:
```bash
aws kms create-key \
  --key-usage SIGN_VERIFY \
  --key-spec ECC_ED25519 \
  --region {region}
```

## Environment Configuration

Three environment variables control the KMS signer:

1. **ERST_KMS_KEY_ID**: ARN or ID of the KMS key
   - Example: `arn:aws:kms:us-east-1:123456789012:key/12345678-1234-1234-1234-123456789012`

2. **ERST_KMS_PUBLIC_KEY_PEM**: Ed25519 public key in PEM format (SPKI)
   - Retrieved from KMS via `get-public-key` operation
   - Used for audit trail verification
   - Must be stored securely and not embedded in code

3. **ERST_KMS_REGION**: AWS region (optional, defaults to `us-east-1`)
   - Example: `us-east-1`, `eu-west-1`, `ap-southeast-1`

## Signature Verification

Signatures generated by KMS can be verified using the corresponding public key:

```typescript
import { verify } from 'crypto';

const isValid = verify(
  null,
  Buffer.from(messageHash),
  publicKeyPEM,
  Buffer.from(signature)
);
```

The signature format matches Ed25519 IETF standards (RFC 8032) and is compatible with standard cryptographic libraries.

## Implementation Details

### Plugin Architecture
- **File**: `src/audit/signing/kmsSigner.ts`
- **Class**: `KmsEd25519Signer`
- **Interface**: Implements `AuditSigner` for audit trail signing
- **Dependencies**: `@aws-sdk/client-kms`

### Error Handling
The plugin throws descriptive errors for:
- Missing environment variables (configuration errors)
- KMS API failures (network, permissions, invalid key)
- Invalid KMS responses (malformed or missing signature)

All errors are wrapped with context prefix: `kms signing failed: {detailed-message}`

### Performance Characteristics
- Single synchronous initialization (credential chain resolution)
- Async signing operations (network call to KMS)
- No local key material stored (leverages AWS KMS key management)
- Suitable for audit trail generation in asynchronous contexts

### Security Properties
- **Key Material**: Never leaves AWS KMS infrastructure
- **Authentication**: Uses AWS SigV4 credentials from environment
- **Encryption in Transit**: TLS 1.2+ enforced by AWS SDK
- **Audit Logging**: All operations logged in AWS CloudTrail
